name: Docker Image CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:
env:
  CONTAINER_NAME: devops
  CONTAINER_IMAGE: "screen15/devops:latest"
  TF_VAR_VMNAME: diplom
  # TF_ADDRESS: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/tf_state
  # TF_ROOT: ${CI_PROJECT_DIR}/infrastructure/tf/

jobs:
  golangci:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v3
        with:
          go-version: 1.17
      - uses: actions/checkout@v3
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          # Optional: version of golangci-lint to use in form of v1.2 or v1.2.3 or `latest` to use the latest version
          version: v1.29
          # Optional: working directory, useful for monorepos
          working-directory: docker-gs-ping

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: test the Docker image
      run: |
        cd ./docker-gs-ping
        docker build -t docker-gs-ping:latest .
        go test -v main_test.go

  docker: 
    name: Docker  
    runs-on: ubuntu-latest
    needs: [golangci, test]
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      - name: Docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
      - name: build docker image
        run: |
          cd ./docker-gs-ping/
          docker build -t docker-gs-ping -f Dockerfile .
          docker tag docker-gs-ping:latest ${{secrets.DOCKERHUB_USERNAME}}/devops:latest
      - name: docker push
        run: docker push ${{secrets.DOCKERHUB_USERNAME}}/devops
        
  terraform-init-plan:
    name: 'Terraform plan'
    runs-on: ubuntu-latest
    needs: docker

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3

    # Checks that all Terraform configuration files adhere to a canonical format
    - name: Terraform Format
      run: terraform fmt -check

    # Generates an execution plan for Terraform
    - name: Terraform Plan
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        cd ./tf/
        terraform init -input=false
        terraform plan 

  terraform-apply:
    name: 'Terraform apply'
    runs-on: ubuntu-latest
    needs: terraform-init-plan

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
      # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3

      # On push to "master", build or change infrastructure according to Terraform configuration files
      # Note: It is recommended to set up a required "strict" status check in your repository for "Terraform Cloud". See the documentation on "strict" required status checks for more information: https://help.github.com/en/github/administering-a-repository/types-of-required-status-checks
    - name: Terraform Apply
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      # if: github.ref == 'refs/heads/"master"' && github.event_name == 'push'
      run: |
        cd ./tf/
        terraform init -input=false
        terraform apply -auto-approve 

  ansible:
    name: ansible
    runs-on: ubuntu-latest
    needs: terraform-apply
    steps:
      # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3
    - name: run command
      run: export ANSIBLE_HOST_KEY_CHECKING=False
    - name: Run Ansible playbook
      uses: dawidd6/action-ansible-playbook@v2.6.1
      with:
          playbook: playbook.yml # path to your Ansible playbook
          directory: ./ansible/
          key: ${{secrets.SSH_PRIVATE_KEY}} # the ssh private key for ansible to use to connect to the servers, stored as "ansible_ssh_private_key" in the GitHub secrets
          inventory: ./ansible/aws_ec2.yml # the ansible inventory to use, stored as "ansible_inventory" in the GitHub secrets
